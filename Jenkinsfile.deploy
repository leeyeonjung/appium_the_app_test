// Jenkinsfile.deploy - BUILD Job for Android APK (theapp_deploy)
// Agent: linux_02
// Purpose: Build Debug APK â†’ Test â†’ Build Release APK

pipeline {
    agent { label 'linux_02' }
    
    environment {
        ANDROID_HOME = '/home/ubuntu/android-sdk'
        PATH = "${ANDROID_HOME}/cmdline-tools/latest/bin:${ANDROID_HOME}/platform-tools:${ANDROID_HOME}/build-tools/33.0.0:${env.PATH}"
    }
    
    stages {
        stage('Checkout Android Project') {
            steps {
                echo 'ğŸ“¥ Checking out Android project from GitHub...'
                checkout scm
            }
        }
        
        stage('Verify Environment') {
            steps {
                echo 'ğŸ” Verifying build environment...'
                sh '''
                    echo "ANDROID_HOME: $ANDROID_HOME"
                    
                    echo "Java version:"
                    java -version
                    
                    echo ""
                    echo "Node.js version:"
                    node --version
                    
                    echo "npm version:"
                    npm --version
                    
                    echo ""
                    echo "Setting executable permissions for Android tools..."
                    chmod +x $ANDROID_HOME/platform-tools/* 2>/dev/null || true
                    chmod +x $ANDROID_HOME/build-tools/33.0.0/* 2>/dev/null || true
                    
                    echo "ADB version:"
                    adb --version
                '''
            }
        }
        
        stage('Install Dependencies') {
            steps {
                echo 'ğŸ“¦ Installing npm dependencies...'
                sh 'npm install'
            }
        }
        
        stage('Build Debug APK') {
            steps {
                echo 'ğŸ”¨ Building Debug APK for testing...'
                dir('android') {
                    sh '''
                        chmod +x ./gradlew
                        ./gradlew clean assembleDebug
                    '''
                }
            }
        }
        
        stage('Verify Debug APK') {
            steps {
                echo 'ğŸ“± Verifying Debug APK...'
                sh '''
                    ls -lh android/app/build/outputs/apk/debug/app-debug.apk
                '''
            }
        }
        
        stage('Archive Debug APK') {
            steps {
                echo 'ğŸ“¦ Archiving Debug APK for testing...'
                archiveArtifacts artifacts: 'android/app/build/outputs/apk/debug/app-debug.apk',
                                 fingerprint: true,
                                 allowEmptyArchive: false
            }
        }
        
        stage('Run Tests with Debug APK') {
            steps {
                echo 'ğŸ§ª Triggering theapp_test with Debug APK...'
                script {
                    echo "Starting test job: theapp_test"
                    
                    def testResult = build job: 'theapp_test',
                                           parameters: [
                                               string(name: 'APK_BUILD_NUMBER', value: "${env.BUILD_NUMBER}"),
                                               string(name: 'APK_TYPE', value: 'debug')
                                           ],
                                           wait: true,
                                           propagate: true
                    
                    echo "âœ… Tests passed! theapp_test #${testResult.number} completed successfully"
                    echo "ğŸ“Š Test report: ${env.JENKINS_URL}job/theapp_test/${testResult.number}/"
                }
            }
        }
        
        stage('Build Release APK') {
            steps {
                echo 'ğŸš€ Tests passed! Building Release APK...'
                dir('android') {
                    sh './gradlew assembleRelease'
                }
            }
        }
        
        stage('Verify Release APK') {
            steps {
                echo 'ğŸ“± Verifying Release APK...'
                sh '''
                    ls -lh android/app/build/outputs/apk/release/app-release.apk
                    
                    echo ""
                    echo "APK Info:"
                    file android/app/build/outputs/apk/release/app-release.apk
                '''
            }
        }
        
        stage('Archive Release APK') {
            steps {
                echo 'ğŸ“¦ Archiving Release APK (production-ready)...'
                archiveArtifacts artifacts: 'android/app/build/outputs/apk/release/app-release.apk',
                                 fingerprint: true,
                                 allowEmptyArchive: false
            }
        }
    }
    
    post {
        success {
            echo "âœ… Build #${env.BUILD_NUMBER} completed successfully!"
            echo "ğŸ§ª Debug APK tested and passed"
            echo "ğŸ“¦ Release APK is ready for deployment"
        }
        failure {
            echo 'âŒ Build or tests failed!'
            echo 'Release APK was not created'
        }
        cleanup {
            echo 'ğŸ§¹ Cleaning workspace...'
            cleanWs()
        }
    }
}
